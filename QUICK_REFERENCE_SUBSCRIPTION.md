# âš¡ RÃ©fÃ©rence Rapide - SystÃ¨me d'Abonnement

## ğŸ¯ Structure des Plans

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PLAN GRATUIT                         â”‚
â”‚                       Gratuit                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ 1 publication total (offre OU Ã©vÃ©nement)              â”‚
â”‚ â€¢ 0 crÃ©dit boost par mois                               â”‚
â”‚ â€¢ Profil commerce de base                               â”‚
â”‚ â€¢ Support communautaire                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PLAN PLUS MENSUEL                      â”‚
â”‚                    $8 / mois                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ 10 publications totaux (offres ET Ã©vÃ©nements)         â”‚
â”‚ â€¢ 1 crÃ©dit boost par mois (auto-renouvelÃ©)              â”‚
â”‚ â€¢ Profil commerce complet                               â”‚
â”‚ â€¢ Support prioritaire                                   â”‚
â”‚ â€¢ Statistiques avancÃ©es                                 â”‚
â”‚ â€¢ FonctionnalitÃ©s premium                               â”‚
â”‚                                                         â”‚
â”‚ CoÃ»t annuel : $96                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PLAN PLUS ANNUEL                       â”‚
â”‚              $88 / an  ğŸ’° Ã‰CONOMISEZ $8                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ 10 publications totaux (offres ET Ã©vÃ©nements)         â”‚
â”‚ â€¢ 1 crÃ©dit boost par mois (auto-renouvelÃ©)              â”‚
â”‚ â€¢ Profil commerce complet                               â”‚
â”‚ â€¢ Support prioritaire                                   â”‚
â”‚ â€¢ Statistiques avancÃ©es                                 â”‚
â”‚ â€¢ FonctionnalitÃ©s premium                               â”‚
â”‚                                                         â”‚
â”‚ Ã‰quivaut Ã  : $7.33/mois                                 â”‚
â”‚ Ã‰conomie : 17% par rapport au mensuel                   â”‚
â”‚ = 2 mois gratuits !                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Variables d'Environnement Stripe

### Tableau de Correspondance

| Variable | Environnement | Valeur Exemple | Description |
|----------|---------------|----------------|-------------|
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Test | `pk_test_...` | ClÃ© publique test |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Live | `pk_live_...` | ClÃ© publique production |
| `STRIPE_SECRET_KEY` | Test | `sk_test_...` | ClÃ© secrÃ¨te test |
| `STRIPE_SECRET_KEY` | Live | `sk_live_...` | ClÃ© secrÃ¨te production |
| `STRIPE_SUBSCRIPTION_PRICE_ID` | Test | `price_1ABC...` | Prix mensuel test |
| `STRIPE_SUBSCRIPTION_PRICE_ID` | Live | `price_live_1ABC...` | Prix mensuel production |
| `STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID` | Test | `price_1DEF...` | Prix annuel test |
| `STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID` | Live | `price_live_1DEF...` | Prix annuel production |
| `STRIPE_BOOST_EN_VEDETTE_PRICE_ID` | Test/Live | `price_...` | Boost en vedette |
| `STRIPE_BOOST_VISIBILITE_PRICE_ID` | Test/Live | `price_...` | Boost visibilitÃ© |
| `STRIPE_WEBHOOK_SECRET` | Test | `whsec_...` | Secret webhook test |
| `STRIPE_WEBHOOK_SECRET` | Live | `whsec_...` | Secret webhook production |

---

## ğŸ“‚ Structure des Fichiers ModifiÃ©s

```
gosholo-partner/
â”‚
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ stripe.ts                    âœ… MODIFIÃ‰
â”‚       â”œâ”€â”€ STRIPE_PRICES
â”‚       â”‚   â”œâ”€â”€ subscriptionMonthly  (nouveau nom)
â”‚       â”‚   â”œâ”€â”€ subscriptionAnnual   ğŸ†• NOUVEAU
â”‚       â”‚   â”œâ”€â”€ boostEnVedette
â”‚       â”‚   â””â”€â”€ boostVisibilite
â”‚       â””â”€â”€ SUBSCRIPTION_PLANS       ğŸ†• NOUVEAU
â”‚           â”œâ”€â”€ monthly (8$/mois)
â”‚           â””â”€â”€ annual (88$/an)
â”‚
â”œâ”€â”€ app/api/stripe/
â”‚   â”œâ”€â”€ create-subscription/
â”‚   â”‚   â””â”€â”€ route.ts                 âœ… MODIFIÃ‰
â”‚   â”‚       â”œâ”€â”€ Accepte "interval" dans body
â”‚   â”‚       â”œâ”€â”€ SÃ©lectionne le bon Price ID
â”‚   â”‚       â””â”€â”€ Sauvegarde interval en metadata
â”‚   â”‚
â”‚   â””â”€â”€ webhooks/
â”‚       â””â”€â”€ route.ts                 âšª INCHANGÃ‰
â”‚           â””â”€â”€ Traite checkout.session.completed
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ subscription-management-flow.tsx  âœ… MODIFIÃ‰
â”‚       â”œâ”€â”€ Toggle Mensuel/Annuel    ğŸ†• NOUVEAU
â”‚       â”œâ”€â”€ Prix dynamiques
â”‚       â”œâ”€â”€ Badge -17%               ğŸ†• NOUVEAU
â”‚       â””â”€â”€ Message Ã©conomies        ğŸ†• NOUVEAU
â”‚
â”œâ”€â”€ ANNUAL_SUBSCRIPTION_SETUP.md     ğŸ†• NOUVEAU
â”œâ”€â”€ QUICK_REFERENCE_SUBSCRIPTION.md  ğŸ†• NOUVEAU (ce fichier)
â””â”€â”€ STRIPE_PRODUCTION_MIGRATION.md   âœ… MIS Ã€ JOUR
```

---

## ğŸ”„ Flux de Paiement Annuel

```
1. Utilisateur clique "Passer au Plus"
   â”‚
   â”œâ”€ SÃ©lectionne "Annuel" dans le toggle
   â”‚  â””â”€ Prix affichÃ© : $88/an
   â”‚     Badge : -17%
   â”‚     Message : "Ã‰conomisez $8 (2 mois gratuits)"
   â”‚
2. Click sur le bouton
   â”‚
   â”œâ”€ Frontend â†’ POST /api/stripe/create-subscription
   â”‚  Body: { interval: "annual" }
   â”‚
3. API Backend
   â”‚
   â”œâ”€ VÃ©rifie interval = "annual"
   â”œâ”€ SÃ©lectionne STRIPE_PRICES.subscriptionAnnual
   â”œâ”€ CrÃ©e session Stripe Checkout
   â”‚  â””â”€ metadata: { interval: "annual", userId, type: "subscription" }
   â”‚
4. Redirect vers Stripe Checkout
   â”‚
   â”œâ”€ Affiche "Abonnement Pro Annuel - $88.00/year"
   â”œâ”€ Utilisateur entre carte bancaire
   â”‚
5. Paiement acceptÃ©
   â”‚
   â”œâ”€ Stripe envoie webhook: checkout.session.completed
   â”‚
6. Webhook Handler
   â”‚
   â”œâ”€ Met Ã  jour profiles.is_subscribed = true
   â”œâ”€ Ajoute 1 crÃ©dit boost en vedette
   â”œâ”€ Ajoute 1 crÃ©dit boost visibilitÃ©
   â”œâ”€ CrÃ©e record dans subscriptions
   â”‚  â””â”€ plan_type: "pro", status: "active"
   â”‚
7. Redirection vers l'app
   â”‚
   â””â”€ Utilisateur voit son statut "AbonnÃ© Pro"
      â””â”€ Prochaine facturation : dans 1 an
```

---

## ğŸ§ª Tests Cartes Stripe

### Carte de Test Standard
```
NumÃ©ro : 4242 4242 4242 4242
Date   : 12/34 (ou toute date future)
CVC    : 123
ZIP    : 12345
```

### Autres Cartes Utiles
```
Visa (dÃ©bit)           : 4000 0566 5566 5556
Mastercard            : 5555 5555 5555 4444
Amex                  : 3782 822463 10005
Carte dÃ©clinÃ©e        : 4000 0000 0000 0002
Authentification 3D   : 4000 0025 0000 3155
```

---

## ğŸ“Š Comparaison des Plans

| CritÃ¨re | Gratuit | Mensuel | Annuel |
|---------|---------|---------|--------|
| **Prix** | Gratuit | $8/mois | $88/an |
| **Prix Ã©quivalent mensuel** | - | $8.00 | $7.33 |
| **Ã‰conomie vs Mensuel** | - | - | -$8/an (-17%) |
| **Publications** | 1 | 10 | 10 |
| **Boosts/mois** | 0 | 1 | 1 |
| **Support** | Communautaire | Prioritaire | Prioritaire |
| **Facturation** | - | Tous les mois | Tous les ans |

---

## ğŸš€ Checklist de DÃ©ploiement Rapide

### Mode Test
```bash
1. âœ… CrÃ©er produit annuel dans Stripe (Test)
2. âœ… Copier Price ID test
3. âœ… Ajouter STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID sur Vercel
4. âœ… Deployer le code
5. âœ… Tester le toggle mensuel/annuel
6. âœ… Tester paiement avec carte test (4242...)
7. âœ… VÃ©rifier webhook rÃ©ussi
8. âœ… VÃ©rifier crÃ©dits boost ajoutÃ©s
```

### Mode Production
```bash
1. âœ… CrÃ©er produit annuel dans Stripe (Live)
2. âœ… Copier Price ID live
3. âœ… Mettre Ã  jour STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID (live)
4. âœ… RedÃ©ployer
5. âœ… Tester avec vraie carte (petits montants)
6. âœ… Monitorer webhooks en production
```

---

## ğŸ” DÃ©bogage Rapide

### ProblÃ¨me : Toggle ne s'affiche pas
```bash
# Solution 1 : Vider cache
Ctrl+Shift+R (Windows) ou Cmd+Shift+R (Mac)

# Solution 2 : VÃ©rifier le build
# Dans Vercel Dashboard â†’ Deployments
# S'assurer que le dernier build est âœ…
```

### ProblÃ¨me : Erreur "STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID is not set"
```bash
# Solution : Ajouter la variable d'environnement
1. Vercel Dashboard â†’ Settings â†’ Environment Variables
2. Ajouter : STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID
3. Valeur : price_... (le Price ID de Stripe)
4. RedÃ©ployer
```

### ProblÃ¨me : Paiement ne fonctionne pas
```bash
# VÃ©rifications :
1. Stripe Dashboard â†’ Developers â†’ API keys
   â†’ VÃ©rifier que les clÃ©s correspondent (test avec test, live avec live)

2. Stripe Dashboard â†’ Products
   â†’ VÃ©rifier que le produit annuel existe
   â†’ Copier le bon Price ID

3. Vercel â†’ Environment Variables
   â†’ VÃ©rifier STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID
   â†’ Doit correspondre au Price ID du produit

4. Stripe Dashboard â†’ Webhooks
   â†’ VÃ©rifier que le webhook est actif
   â†’ URL : https://votre-site.vercel.app/api/stripe/webhooks
   â†’ Ã‰vÃ©nements : checkout.session.completed, payment_intent.succeeded
```

---

## ğŸ“ Liens Utiles

| Ressource | URL |
|-----------|-----|
| **Stripe Dashboard Test** | https://dashboard.stripe.com/test |
| **Stripe Dashboard Live** | https://dashboard.stripe.com |
| **Stripe Products** | https://dashboard.stripe.com/products |
| **Stripe Webhooks** | https://dashboard.stripe.com/webhooks |
| **Stripe Test Cards** | https://stripe.com/docs/testing |
| **Vercel Dashboard** | https://vercel.com/dashboard |
| **Stripe Documentation** | https://stripe.com/docs |
| **Stripe Support** | https://support.stripe.com |

---

## ğŸ’¡ Points ClÃ©s Ã  Retenir

1. **Deux Plans Pro** : Mensuel ($8/mois) et Annuel ($88/an)
2. **Ã‰conomie de 17%** : Le plan annuel Ã©conomise 2 mois ($8)
3. **MÃªme fonctionnalitÃ©s** : Les deux plans Pro ont les mÃªmes avantages
4. **Toggle UI** : Interface simple pour choisir mensuel ou annuel
5. **Variables distinctes** : `STRIPE_SUBSCRIPTION_PRICE_ID` (mensuel) et `STRIPE_SUBSCRIPTION_ANNUAL_PRICE_ID` (annuel)
6. **Metadata Stripe** : L'intervalle est sauvegardÃ© dans `metadata.interval`
7. **Test d'abord** : Toujours tester en mode Test avant la production
8. **MÃªme webhook** : Un seul webhook gÃ¨re les deux types d'abonnement

---

**DerniÃ¨re mise Ã  jour** : Octobre 2024  
**Version** : 1.0

